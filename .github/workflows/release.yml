name: Build & Publish Windows Installer

on:
  push:
    tags: ['V*']
  workflow_dispatch:
    inputs:
      version:
        description: "Versão para testar (ex: 0.1.10)"
        required: false
        type: string

permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Resolver versão
        id: v
        shell: pwsh
        run: |
          $manual = "${{ github.event.inputs.version }}".Trim()
          if ($manual) {
            $ver = $manual
          } else {
            $tag = "${{ github.ref_name }}"
            if ($tag -match '^[Vv](.+)$') { $ver = $Matches[1] } else { $ver = $tag }
          }
          echo "version=$ver" >> $env:GITHUB_OUTPUT

      - name: Setup Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Gerar version.py para a GUI
        shell: pwsh
        run: |
          $ver = "${{ steps.v.outputs.version }}"
          @"
          __version__ = "$ver"
          "@ | Out-File -FilePath .\version.py -Encoding UTF8

      - name: Instalar Inno Setup
        shell: pwsh
        run: choco install innosetup --yes

      - name: Instalar PyInstaller + Pillow
        shell: pwsh
        run: python -m pip install -U pip pyinstaller pillow

      # (Opcional) Build do launcher com PyInstaller
      - name: Build launcher.exe (opcional)
        shell: pwsh
        run: |
          if (Test-Path ".\updater\launcher.py") {
            python -m PyInstaller --onefile --noconsole -n launcher .\updater\launcher.py
          } else {
            echo "Sem updater/launcher.py; pulando."
          }

      - name: Gerar app.ico a partir do favicon
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path assets | Out-Null
          $src = "public\favicon.ico"
          if (-not (Test-Path $src)) { $src = "public\favicon.png" }
          if (-not (Test-Path $src)) { throw "Favicon não encontrado (public\favicon.ico ou public\favicon.png)" }

                    $py = @"
          from PIL import Image
          from pathlib import Path
          src = Path(r'$src')
          dst = Path(r'assets\app.ico')
          img = Image.open(src)
          sizes = [(16,16),(32,32),(48,48),(64,64),(128,128),(256,256)]
          img.save(dst, sizes=sizes)
          print('ICO gerado em', dst)
          "@
          Set-Content -Path gen_ico.py -Value $py -Encoding UTF8
          python gen_ico.py

      - name: Build gui.exe (com ícone)
        shell: pwsh
        run: |
          pyinstaller --onefile --noconsole --icon assets\app.ico --name gui GUI.py

      - name: Compilar instalador (Inno Setup)
        shell: pwsh
        run: |
          $iss = "installer\gestao_with_python.iss"
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" `
            "/DMyAppVersion=${{ steps.v.outputs.version }}" `
            $iss

      - name: Localizar instalador gerado
        id: artef
        shell: pwsh
        run: |
          Write-Host "== Conteúdo de installer\Output =="
          if (Test-Path "installer\Output") {
            Get-ChildItem -Recurse "installer\Output" | ForEach-Object { $_.FullName }
          } else {
            throw "Pasta installer\Output não encontrada (a compilação do Inno falhou?)."
          }

          # Escolhe o .exe mais recente
          $match = Get-ChildItem -Path "installer\Output" -Filter "*.exe" |
                   Sort-Object LastWriteTime -Descending |
                   Select-Object -First 1

          if (-not $match) {
            throw "Nenhum instalador .exe encontrado em installer\Output. Verifique OutputBaseFilename no .iss."
          }

          $full = $match.FullName
          $unix = $full -replace '\\','/'
          $fname = $match.Name

          Write-Host "Instalador encontrado: $full"
          "exe=$unix"   >> $env:GITHUB_OUTPUT
          "fname=$fname" >> $env:GITHUB_OUTPUT

      - name: Anexar ao release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ steps.artef.outputs.exe }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Publicar instalador como artifact (teste)
        if: ${{ github.event_name == 'workflow_dispatch' }}
        uses: actions/upload-artifact@v4
        with:
          name: Gestao-Setup-${{ steps.v.outputs.version }}.exe
          path: ${{ steps.artef.outputs.exe }}
          
      - name: Atualizar latest.json no main
        if: startsWith(github.ref, 'refs/tags/')
        shell: pwsh
        run: |
          $tag   = "${{ github.ref_name }}"
          $fname = "${{ steps.artef.outputs.fname }}"
          $url   = "https://github.com/${{ github.repository }}/releases/download/$tag/$fname"
          $hash  = (Get-FileHash "${{ steps.artef.outputs.exe }}" -Algorithm SHA256).Hash

          # 1) Troca para a branch main e sincroniza
          git fetch origin main
          git checkout main
          git pull --rebase origin main

          # 2) Recria latest.json com a versão publicada
          $json = @{
            version   = "${{ steps.v.outputs.version }}"
            windows   = @{ installer_url = $url; sha256 = $hash }
            mandatory = $false
            notes     = "Auto-update"
          } | ConvertTo-Json -Depth 4
          Set-Content latest.json $json -Encoding UTF8

          # 3) Commit & push
          git config user.name  "github-actions"
          git config user.email "github-actions@users.noreply.github.com"
          git add latest.json
          git commit -m "chore: update latest.json for $tag" || echo "sem mudanças"
          git push origin main
