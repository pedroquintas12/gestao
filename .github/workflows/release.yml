name: Build & Publish Windows Installer

on:
  push:
    tags: ['V*']
  workflow_dispatch:
    inputs:
      version:
        description: "Versão para testar (ex: 0.1.10)"
        required: false
        type: string

permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Resolver versão
        id: v
        shell: pwsh
        run: |
          $manual = "${{ github.event.inputs.version }}".Trim()
          if ($manual) {
            $ver = $manual
          } else {
            $tag = "${{ github.ref_name }}"
            if ($tag -match '^[Vv](.+)$') { $ver = $Matches[1] } else { $ver = $tag }
          }
          echo "version=$ver" >> $env:GITHUB_OUTPUT

      # Garante Python disponível (py launcher às vezes não tem 3.12)
      - name: Setup Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Gerar version.py para a GUI
        shell: pwsh
        run: |
          $ver = "${{ steps.v.outputs.version }}"
          @"
          __version__ = "$ver"
          "@ | Out-File -FilePath .\version.py -Encoding UTF8

      - name: Instalar Inno Setup
        shell: pwsh
        run: choco install innosetup --yes

      - name: Instalar PyInstaller
        shell: pwsh
        run: python -m pip install -U pip pyinstaller

      # (Opcional) Build do launcher com PyInstaller
      - name: Build launcher.exe (opcional)
        shell: pwsh
        run: |
          if (Test-Path ".\updater\launcher.py") {
            python -m PyInstaller --onefile --noconsole -n launcher .\updater\launcher.py
          } else {
            echo "Sem updater/launcher.py; pulando."
          }
      - name: Instalar PyInstaller + Pillow
        shell: pwsh
        run: |
          python -m pip install -U pip pyinstaller pillow

      # Converte o favicon para um .ico válido multi-res
      - name: Gerar app.ico a partir do favicon
        shell: pwsh
        run: |
          $src = "public\favicon.ico"   # pode ser .png também
          $dst = "assets\app.ico"
          if (!(Test-Path $src)) { throw "Favicon não encontrado em $src" }
          python - << 'PY'
          from PIL import Image
          import sys, os  
          src = r"public\favicon.ico"
          dst = r"assets\app.ico"
          img = Image.open(src)            # abre .png ou .ico
          img.save(dst, sizes=[(16,16),(32,32),(48,48),(64,64),(128,128),(256,256)])
          print("ICO gerado em", dst)
          PY
      - name: Build gui.exe (com ícone)
        shell: pwsh
        run: |
          pyinstaller --onefile --noconsole --icon assets\app.ico --name gui GUI.py


      - name: Compilar instalador (Inno Setup)
        shell: pwsh
        run: |
          $iss = "installer\gestao_with_python.iss"
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" `
            "/DMyAppVersion=${{ steps.v.outputs.version }}" `
            $iss

      - name: Renomear artefato final
        id: artef
        shell: pwsh
        run: |
          $exe = "installer\Output\Gestao-Setup-${{ steps.v.outputs.version }}.exe"
          if (!(Test-Path $exe)) { throw "Instalador não encontrado: $exe" }
          echo "exe=$exe" >> $env:GITHUB_OUTPUT

      - name: Anexar ao release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ steps.artef.outputs.exe }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Publicar instalador como artifact (teste)
        if: ${{ github.event_name == 'workflow_dispatch' }}
        uses: actions/upload-artifact@v4
        with:
          name: Gestao-Setup-${{ steps.v.outputs.version }}.exe
          path: ${{ steps.artef.outputs.exe }}

      - name: Atualizar latest.json no main
        if: startsWith(github.ref, 'refs/tags/')
        shell: pwsh
        run: |
          $tag = "${{ github.ref_name }}"
          $url = "https://github.com/${{ github.repository }}/releases/download/$tag/Gestao-Setup-${{ steps.v.outputs.version }}.exe"
          $hash = (Get-FileHash "${{ steps.artef.outputs.exe }}" -Algorithm SHA256).Hash
          $json = @{
            version  = "${{ steps.v.outputs.version }}"
            windows  = @{ installer_url = $url; sha256 = $hash }
            mandatory = $false
            notes     = "Auto-update"
          } | ConvertTo-Json -Depth 4
          Set-Content latest.json $json -Encoding UTF8
          git config user.name  "github-actions"
          git config user.email "github-actions@users.noreply.github.com"
          git add latest.json
          git commit -m "chore: update latest.json for $tag" || echo "sem mudanças"
          git push origin HEAD:main
