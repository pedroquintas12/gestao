name: Build & Publish Windows Installer

on:
  push:
    tags:
      - 'V*'
  workflow_dispatch:
    inputs:
      version:
        description: "VersÃ£o para testar (ex: 0.1.10)"
        required: false
        type: string

permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Resolver versÃ£o
        id: v
        shell: pwsh
        run: |
          $manual = "${{ github.event.inputs.version }}".Trim()
          if ($manual) {
            $ver = $manual
          } else {
            $tag = "${{ github.ref_name }}"
            if ($tag -match '^[Vv](.+)$') { $ver = $Matches[1] } else { $ver = $tag }
          }
          echo "version=$ver" >> $env:GITHUB_OUTPUT

      - name: Instalar Inno Setup
        shell: pwsh
        run: choco install innosetup --yes

      - name: (Opcional) Build do launcher com PyInstaller
        shell: pwsh
        run: |
          py -3.12 -m pip install -U pip pyinstaller
          py -3.12 -m PyInstaller --onefile ./updater/launcher.py -n launcher.exe

      - name: Compilar instalador (Inno Setup)
        shell: pwsh
        run: |
          $iss = "installer\\gestao_with_python.iss"
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" `
            "/DMyAppVersion=${{ steps.v.outputs.version }}" `
            $iss

      - name: Renomear artefato final
        id: artef
        shell: pwsh
        run: |
          $exe = "installer\\Output\\Gestao-Setup-${{ steps.v.outputs.version }}.exe"
          if (!(Test-Path $exe)) { throw "Instalador nÃ£o encontrado: $exe" }
          echo "exe=$exe" >> $env:GITHUB_OUTPUT

      # ðŸ‘‰ Se for TAG: anexa no release
      - name: Anexar ao release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ steps.artef.outputs.exe }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ðŸ‘‰ Se for DISPATCH (teste): sÃ³ publicar como artifact do workflow
      - name: Publicar instalador como artifact (teste)
        if: ${{ github.event_name == 'workflow_dispatch' }}
        uses: actions/upload-artifact@v4
        with:
          name: Gestao-Setup-${{ steps.v.outputs.version }}.exe
          path: ${{ steps.artef.outputs.exe }}

      # (Opcional) Atualizar latest.json â€” sÃ³ em tag
      - name: Atualizar latest.json no main
        if: startsWith(github.ref, 'refs/tags/')
        shell: pwsh
        run: |
          $tag = "${{ github.ref_name }}"
          $url = "https://github.com/${{ github.repository }}/releases/download/$tag/Gestao-Setup-${{ steps.v.outputs.version }}.exe"
          $hash = (Get-FileHash "${{ steps.artef.outputs.exe }}" -Algorithm SHA256).Hash
          $json = @{
            version  = "${{ steps.v.outputs.version }}"
            windows  = @{ installer_url = $url; sha256 = $hash }
            mandatory = $false
            notes     = "Auto-update"
          } | ConvertTo-Json -Depth 4
          Set-Content latest.json $json -Encoding UTF8

          git config user.name  "github-actions"
          git config user.email "github-actions@users.noreply.github.com"
          git add latest.json
          git commit -m "chore: update latest.json for $tag" || echo "sem mudanÃ§as"
          git push origin HEAD:main
